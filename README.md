# RCカー用ジャイロ"GyroPID"

---

RCカー（無線操縦車）用ジャイロをM5StickC開発ボード（実売価格≒3K円）で自作する方法を紹介します。
M5StickCは、ヨーレート（回頭角速度）計測用のIMU（慣性計測ユニット）、サーボ制御用のハードウェアPWM（パルス幅変調）、パラメータ調整用のLCD（液晶ディスプレイ）を備えており、RCカー用ジャイロの自作に最適です。
プログラム"GyroPID.ino"をArduinoIDEでコンパイル＆転送してR/C受信機及びサーボと接続するだけで、M5StickC単体でR/Cカー用ジャイロとして機能します。

![ラジコン画像](https://user-images.githubusercontent.com/64751855/117384511-1d46f000-af1e-11eb-854e-45ee149e4671.jpg)


# 動機

自分は、コロナ禍で屋内遊びをさがす中で、小学生以来めっちゃ久しぶりにタミヤ製RCカーキット（小型のSU-01シャーシ）を購入してみました。
購入後、RCカー系YouTubeチャンネルを見ていて、子ども時代に存在しなかったドリフト用RCカー（通称、ドリラジ）の動きに興味を持ちました。
ツルツルのタイヤで横滑りさせながらRCカーを走らせるアレです。
ドリフト用RCカーは、ジャンルとして確立しており、たとえばヨコモYD-2のように専用設計かつ完成度の高い製品が存在します。
純粋にRCカーのドリフト走行を楽しみたければ、ドリフト専用のシャーシやジャイロ製品を入手するのが最短コースだと思います。

自分の場合、ドリラジの存在に気付いたのがR/Cカーキット購入後だったこと、
どんなRCカーでも上手く制御できればドリフト走行（を安定化）可能だと思い込んでいたことから、
タミヤ最安（実売価格≒4K円）のSU-01シャーシを自作ジャイロで制御してドリフト走行にチャレンジしました。
やや回り道しましたが、ほぼノーマル（シャーシを削り舵角を増やすだけ）のSU-01シャーシでドリフト走行できました。

https://user-images.githubusercontent.com/64751855/117522427-4afb6a00-afee-11eb-92c3-ca71cc90cb24.mp4

RCカー用ジャイロの自作は、プログラムやパラメータの変更によりRCカーの走行特性を変えられるので楽しい開発でした。
RCカー好きの人なら自作ジャイロの操縦性を楽しみつつ、プログラミングや制御の仕組みを体験して理解する良い素材（STEM教育の素材？）と思います。
趣味でRCカーやプログラミングを楽しむ人が増えて欲しいとの願いから、開発したRCカー用ジャイロGyroPIDのソースコードを公開します。
この記事を参考に、部品を集めてGyroPIDを再現する人、改造して「オレ専用ジャイロ」を開発する人、が出てくれば自分的にはハッピーです。


# 機能

このRCカー用ジャイロGyroPIDは、ハイエンドのジャイロと同等かそれ以上の機能を備えています。
なお下記"PID"は、汎用性の高い制御アルゴリズムの略称「PID: 比例Proportional、積分Integral、微分Differential」です。

- PID自動制御 <br>車体ヨーレート（回頭角速度）を目標としてステアリング角を自動制御する。
- PID設定保存 <br>ジャイロ制御パラメータ（PIDゲインなど）を自由に変更して保存できる。
- CH1範囲保存 <br>ステアリング角のエンドポイントを保存して自動制御時の制約として守る。
- IMU自動較正 <br>ジャイロ起動時にIMU（慣性計測ユニット）のバイアスを自動較正する。
- LCD画面表示 <br>ジャイロ状態（受信機入力、IMU入力、PID設定値、サーボ出力）をLCD表示する。
- ドリフト検出 <br>ドリフト走行（回頭方向と操舵方向が逆）を自動検出してLCD背景色を変更する。
- オープンソース <br>ソースコードが公開されていて、誰でも理解して自由に改造できる。


# 使い方

RCカー用ジャイロGyroPIDの使い方（本体準備、初期設定から通常利用の流れ）を概説します。
詳しいRCメカとの接続方法、M5StickCの起動方法、PID制御パラメータの解釈は後半を参照ください。

## 本体準備
1. 手持ちのコンピュータにArduinoIDE（開発環境）をインストールする
2. ArduinoIDEの開発ボード設定をM5StickC/ESP32向けに変更する
3. コンピュータとM5StickC開発ボードをUSBケーブルで接続する
4. プログラム"GyroPID.ino"をArduinoIDE経由でM5StickCへ書き込む
6. M5StickC/GyroPIDをRCカーに固定（本体LCD画面が鉛直上向き）してRCメカと接続する

## 初期設定
1. GyroPIDを起動する（起動しない場合、USB給電等で起動）
2. RCメカを起動する（RCメカ起動後、USB給電を外す）
3. GyroPIDの操舵エンドポイントを設定する
4. GyroPIDのPID制御パラメータを設定する（初期値：KG=50、KP=50、KI=30、KD=10）
5. RCカーを走らせて、必要によりPID制御パラメータを調整する

## 通常利用
1. GyroPIDを起動する（起動しない場合、USB給電等で起動）
2. RCメカを起動する（RCメカ起動後、USB給電を外す）
3. RCカーを走らせて、必要によりPID制御パラメータを調整する



# 制御方法

RCカー用GyroPIDは、
ステアリング指示値"ch1_in"をヨーレート計測値"omega"の目標と解釈して、
両者の残差"error:=ch1_in-kg*omega"をゼロに近づけるPID制御により、
ステアリング指令値"ch1_out:=PID(error)"を自動調整します。

- error := ch1_in - kg * omega
- ch1_out := PID(error) = kp * (error + ki * LPF(error) + kd * HPF(error))

上記LPFは積分演算を模擬する「Low Pass Filter」の略称、HPFは微分演算を模擬する「High Pass Filter」の略称です。

つまりGyroPIDは、ステアリング指示値"ch1_in"とステアリング角度"ch1_out"とを一度切り離した上で、
車体ヨーレート"omega"をステアリング指示値"ch1_in"に近づけるようステアリング角度"ch1_out"を自動調整します。
自動調整が成功すると、グリップ走行時はニュートラルに近い回頭性、ドリフト走行時はヨーレートの安定性が高まります。
これがジャイロ搭載の結果、RCカーが操縦し易くなる？という理屈になります。

PID制御のパラメータ（kg、kp、ki、kd）は、タイヤ、車体や路面の状況により調整すべきであり、LCD画面で確認＆変更できます。
テスト用RCカーの場合、PID制御の設定値はKG=50、KP=60、KI=30、KD=10ぐらいの数値でドリフト走行を安定化できました。

PID制御の設定値（大文字）は、数値0〜100程度に規格化しており、PID制御の計算値（小文字）との関係は以下の通りです。

- 角速度"omega"は（ラジアン/秒）単位 <br>慣性センサ（IMU）計測値をセンサ感度に応じて物理量へ変換した数値です。
- 入出力"ch1"は16ビット数（0〜65535） <br>PWMパルス幅（0ms〜20ms=1000ms/50Hz）を示す16ビット数（0〜2^16-1）です。
- 目標ゲイン <br>kg = KG/0.5
- 比例ゲイン <br>kp = KP/50.0
- 積分ゲイン <br>ki = KI/50.0
- 微分ゲイン <br>kd = KD/50.0

GyriPIDの制御周期は「約20ms（約50Hz）」であり、入力から出力までの遅延もR/Cサーボへの指令間隔と同じ20ms以内に収まります。
「約20ms」とした理由は、PWM幅計測に用いた標準関数pulseIn(...)がブロックするので、複数CHのシリアル入力時に20msを超えるからです。
プログラム上、CH1を20ms間隔で入力する一方、CH3を500ms間隔で入力する方式で「約20ms（ただし頻度1/25で時間オーバー）」を満たします。


# 画面表示

RCカー用ジャイロGyroPIDは、以下の5種類の画面状態を遷移します。状態遷移は、ボタン[A]、[B]操作及びタイムアウト時に発生します。
「制御画面」がホーム状態となり、この状態からボタン[A]で「設定画面」へ、ボタン[B]で「CH3選択」へ遷移します。
他の状態の場合、ボタン操作が画面に表示してあるか、無操作のタイムアウトでデフォルト状態「制御画面」へ戻ります。
パラメータ設定は、送信機からステアリングCH1を操作して数値を与えて、ボタン[A]で保存（ボタン[B]で取消）します。
起動直後の「CH3選択」は、PIDパラメータ表の参照が有効で、CH3ゲイン指定が無効です。

![GyroPID](https://user-images.githubusercontent.com/64751855/117384421-df49cc00-af1d-11eb-9d54-8f4c3f73440f.gif)

|画面状態|遷移条件|解説|
|----|----|----|
|起動画面|RC受信機の起動|ジャイロ起動後、RC受信機からPWM信号を受信するまで待機|
|較正画面|タイムアウト|CH1ニュートラル位置、IMUバイアスのサンプリング（この間、送信機操作や車体振動がNG）|
|制御画面|ボタン[A],[B]|PID制御状態（RC受信機入力、ジャイロ入力、サーボ制御量、パラメータなど）の表示|
|設定画面|ボタン[A],[B]|PID制御パラメータ、操舵CH1エンドポイントの保存（電源オフ後も残る）|
|CH3選択|ボタン[B]|CH3入力とPID制御パラメータの対応付けの選択|


# 接続方法

GyroPID利用時のM5StickC開発ボードのGPIO端子とRCメカ類（受信機、サーボ）との接続方法は下記の通りです。

|GPIO端子 |in/out |RCメカ端子 |
|---- |---- |---- |
|G0  |in | RC受信機CH1のシグナル端子|
|G36 |in | RC受信機CH3のシグナル端子|
|G26 |out | RCサーボCH1のシグナル端子|
|GND |in/out | RCアンプBECのマイナス端子|
|5Vin |in | RCアンプBECのプラス端子|

ワイヤハーネス（接続ケーブル）は、CH1入出力用にRCサーボ用のコネクタ付き延長ケーブル1本を中央で切断して、8ピンヘッダ（オス）とハンダ付けすれば完成です。
ゲイン調整用にCH3入力を利用する場合、同様にコネクタ付き延長ケーブルを用いるか、信号線（単線）のみ受信機CH3とG32を接続すれば機能します。
なおCH3をジャイロに接続していない場合、ジャイロはPID制御のパラメータ表を参照します。

![ジャイロ配線](https://user-images.githubusercontent.com/64751855/117226919-aee82c00-ae50-11eb-96f3-b1b861cb95c2.jpg)

信号の電圧レベルに関しては、M5StickC側が3.3Vなのに対して、RCメカ側が通常5.0V以上と高くなる点に十分ご注意ください。
テスト環境（タミヤ製TRE-01、HobbyWing製QuicRun-1060）では、直結で問題なく動いていますが、おそらく許容範囲内でも保証範囲外だと思います。
たとえば走行用バッテリを高電圧サーボに直結している場合、電圧レベルコンバータを省略するとM5StickCが破損（不可逆に故障）する可能性が高いです。

![ジャイロ搭載](https://user-images.githubusercontent.com/64751855/117384355-b75a6880-af1d-11eb-88ad-850f1de2ef77.jpg)


# 電源管理

M5StickCは、電源管理に不具合が残っており、電源ボタンを押しても、素直に電源オンしない場合があります。
原因は、電源管理チップAXPの不具合、内蔵バッテリの電圧低下、GPIOピンの電圧レベル等に起因するそうです。
たとえばキーワード「M5StickC　起動しない」のGoogle検索で、いくつかの対処方法が見つかりますので、
電源まわりのトラブル解決の参考にしてください。

自分のテスト環境でも、起動に成功/失敗する場合が起きますが、M5StickCのワイヤハーネスを取り外してUSB給電すると高確率で起動します。
M5StickC関連ブログ記事に「G0と3V3を直結してUSB給電すれば起動」や「電源投入時のG0電圧に応じてリセット動作」等の記載があります。
内蔵バッテリの充電不足を除いた場合、おそらく電源ボタンを押したタイミングのGPIOピン電圧によりM5StickC起動の成否が決まるようです。

なおジャイロ起動後、電源オフの操作は不要です。
GyroPIDのプログラムが、5Vin端子からBEC電圧の低下を検出するとM5StickCの電源を自発的にオフします。


# テスト環境

自分のようにSU-01シャーシでRWDドリフト走行を試みる人は少ないと思いますが、
参考までにテスト用のRCカー、メカ及びジャイロ搭載例の写真と諸元を記します。

![シャーシ画像](https://user-images.githubusercontent.com/64751855/117116225-1064b800-adc9-11eb-898f-fba45874e475.jpg)

|項目 |型番 |
|----|----|
|シャーシ|タミヤ製SU-01|
|ボディ|タミヤ製ジムニーウイリー（SJ30）|
|タイヤ|TOPLINE製Mシャーシ用ドリフトタイヤ|
|送信機|タミヤ製ファインスペック2.4GHz|
|受信機|タミヤ製TRE-01|
|アンプ|タミヤ製TRE-01|
|サーボ|ヨコモ製S-007|
|バッテリ|7.4V LiPo 1100mAh|
|モータ|ノーマル370型DCモーター|

サーボに関しては、ファインスペック付属のTSU-03だと制御が遅れてハンチングしたので、ある程度の高速なサーボが必須だと思います。
モータに関しては、ノーマルだとLiPoバッテリと組み合わせないと、スピードが出たときにトルク不足でドリフト移行が難しいと思います。
タイヤに関しては、駆動系が非力なので、滑りやすいタイヤが良いと思います。
この他の項目に関しては、いかなる組み合わせでも大丈夫と思います。


# 改良案

R/Cカー用ジャイロ自作を通して、気付いた改良アイデアなどを列挙します。
いずれ対応したいと思いますが、趣味で開発しているので、いつ対応できるか自分でも分かりません。
ご自身で改良にチャレンジする際の参考になれば幸いです。

- パラメータ設定のスマホ対応　<br>スマホのGUI画面からジャイロ設定（PIDゲイン等）を複数管理して変更可能とする。
- パラメータ調整の完全自動化 <br>車体、路面やタイヤに応じたPIDゲインの最適化を強化学習などで完全自動化する。
- スロットル制御のアシスト <br>ドリフト走行の安定化には、ステアリングとスロットルの同時制御が必要です。
- 加速度センサの有効活用 <br>ヨーレートと水平加速度から車体スリップ角を推定してトラクション制御を高度化する。
- ジャイロ固定方向の自由化 <br>鉛直方向を起動時に自動検出して車体ヨーレート成分を決定する。
- PWM入力方式の改善 <br>PWM入力にブロック方式の関数pulseIn(...)を廃止して割り込み方式へと変更する。
- 外部電源との完全連動 <br>M5StickCの内蔵バッテリーを無効化して、R/CアンプBECの給電のみでオン/オフ動作させる。
- 走行データの記録分析 <br>走行データをSDカード等に記録して事後分析できるようにする（M5StickCからM5Stackへ変更？）。

M5StickCは、WiFi/Bluetooth機能を備える点、外部GPIOが5本ある点、6軸IMU機能を備える点、割り込み処理できる点から、
ほとんどの改良案はハードウェア的には実現可能と思いますので、あとはアイデアとソフトウェア次第だと思います。


# 参考資料

RCカー用ジャイロGyroPIDの開発にあたり、参考にした資料などを列挙します。
「元気っ子さん」は、GyroPID搭載RCカーの試験走行、ヨコモYD-2レンタカーの体験走行などで、いつもお世話になっています。

## ホビー用RCカー関連
- [ヨコモ](https://teamyokomo.com/)
- [タミヤ](https://www.tamiya.com/japan/rc/index.html)
- [RCカー練習場「元気っ子さん」](https://genkikkosan.com/)

## ドリフト走行の理屈
- [On the dynamics of automobile drifting](https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.103.9227&rep=rep1&type=pdf)
- [Analysis and control of high sideslip manoeuvres](https://www.tandfonline.com/doi/abs/10.1080/00423111003746140?journalCode=nvsd20)
- [Stabilization of steady-state drifting for a RWD vehicle](http://dcsl.gatech.edu/papers/avec10.pdf)

## ソフトウェア関連
- [M5StickC非公式日本語リファレンス](https://lang-ship.com/reference/unofficial/M5StickC/)
- [M5Stack公式ドキュメント](https://github.com/m5stack/m5-docs/blob/master/docs/ja/README_ja.md)
- [Arduino IDE](https://www.arduino.cc/en/software)
- [PID Controller - Wikipedia](https://en.wikipedia.org/wiki/PID_controller)

## ハードウェア関連
- [M5StickC本体例](https://www.switch-science.com/catalog/5517/)
- [ピンヘッダ（オス）例](https://www.amazon.co.jp/dp/B012HY288S/)
- [サーボ延長ケーブル例](https://www.amazon.co.jp/dp/B00W9ST610/)


以上
